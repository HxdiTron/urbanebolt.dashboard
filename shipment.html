<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbaneBolt • Shipment Detail</title>
    <link rel="icon" type="image/x-icon" href="assets/favicon.ico">
    <link rel="shortcut icon" type="image/x-icon" href="assets/favicon.ico">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- API Integration -->
    <script src="api.js"></script>
    <script src="config.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .premium-shadow { box-shadow: 0 2px 10px rgba(0,0,0,0.02), 0 10px 25px rgba(0,0,0,0.03); }
        .premium-border { border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="text-slate-600 antialiased h-screen flex overflow-hidden">

    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col justify-between z-20 hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.01)]">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <img src="assets/favicon.ico" alt="UrbaneBolt" class="w-8 h-8 rounded-lg object-contain">
                    <div class="flex flex-col">
                        <span class="font-bold tracking-tight text-slate-900 text-sm leading-none">URBANEBOLT</span>
                        <span class="text-[10px] font-medium text-slate-400 mt-1 tracking-wider uppercase">Operations</span>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <div class="px-3 pb-2 pt-2">
                    <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Core Data</p>
                </div>
                
                <a href="index.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-slate-50 text-slate-500 hover:text-slate-900">
                    <iconify-icon icon="solar:widget-2-linear" width="18"></iconify-icon>
                    Overview
                </a>
                
                <div class="px-3 pb-2 pt-6">
                    <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">NDR & Finance</p>
                </div>

                <a href="cod.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-slate-50 text-slate-500 hover:text-slate-900">
                    <iconify-icon icon="solar:bill-list-linear" width="18"></iconify-icon>
                    COD Reconciliation
                </a>
                
                <a href="exceptions.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg hover:bg-slate-50 text-slate-500 hover:text-slate-900">
                    <iconify-icon icon="solar:danger-triangle-linear" width="18"></iconify-icon>
                    RTO & Exceptions
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-slate-100">
            <div class="flex items-center gap-3 w-full p-2">
                <img src="https://ui-avatars.com/api/?name=Hub+Manager&background=0f172a&color=fff" alt="User" class="w-8 h-8 rounded-full shadow-sm">
                <div class="flex flex-col">
                    <span class="text-xs font-semibold text-slate-900">Hub Manager</span>
                    <span class="text-[10px] text-slate-500">UrbaneBolt Dashboard</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
        
        <!-- Header -->
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <a href="index.html" class="text-slate-400 hover:text-slate-900">
                    <iconify-icon icon="solar:arrow-left-linear" width="20"></iconify-icon>
                </a>
                <h1 class="text-lg font-semibold text-slate-900 tracking-tight">Shipment Detail</h1>
                <div id="loadingIndicator" class="hidden">
                    <iconify-icon icon="solar:refresh-linear" width="18" class="animate-spin text-slate-400"></iconify-icon>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <input type="text" id="awbInput" placeholder="Enter AWB..." class="text-xs bg-slate-50 border border-slate-200 rounded-lg px-3 py-2 w-48 font-mono">
                <button onclick="loadShipment()" class="px-4 py-2 text-sm font-semibold text-white bg-slate-900 rounded-lg hover:bg-slate-800">
                    Track
                </button>
            </div>
        </header>

        <!-- Scrollable Content -->
        <div class="flex-1 overflow-y-auto p-8 space-y-8">
            <div id="shipmentContent">
                <div class="bg-white rounded-xl premium-border premium-shadow p-12 text-center">
                    <iconify-icon icon="solar:box-linear" width="48" class="text-slate-300 mb-4"></iconify-icon>
                    <p class="text-slate-500">Enter an AWB number to view shipment details</p>
                </div>
            </div>
        </div>
    </main>

    <script>
        // Ensure API is configured (fallback in case config.js is missing)
        (function ensureApiConfigured() {
            if (typeof API !== 'undefined' && API.getConfig) {
                const config = API.getConfig();
                if (!config.baseUrl) {
                    console.warn('[Fallback] API not configured, applying default config');
                    API.configure({
                        baseUrl: 'https://api.urbanebolt.in',
                        maxBatchSize: 20,
                    });
                }
            }
        })();

        // Check for AWB in URL
        const params = new URLSearchParams(window.location.search);
        const awbFromUrl = params.get('awb');
        if (awbFromUrl) {
            document.getElementById('awbInput').value = awbFromUrl;
            // Wait for API to be configured, then load
            setTimeout(loadShipment, 200);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }

        /** Map status code to human-readable label (for badge and timeline) */
        function statusCodeToDisplayName(code) {
            const map = {
                'DDL': 'Delivered', 'RTD': 'RTO Delivered', 'RTO': 'RTO Initiated', 'RTL': 'RTO Lock',
                'UDD': 'Un-delivered', 'OFD': 'Out for Delivery', 'PKD': 'Picked up', 'MAN': 'Manifested',
                'DDS': 'Out for Delivery', 'NDR': 'NDR', 'CAN': 'Cancelled', 'LOST': 'Lost'
            };
            return map[(code || '').toUpperCase()] || (code || 'Update');
        }

        /** Normalize header for matching (lowercase, no spaces/special chars) */
        function normHeader(h) {
            return String(h || '').toLowerCase().replace(/\s+/g, '').replace(/[^a-z0-9]/gi, '');
        }

        /** Resolve POD URL from doc: first-class delPod, or from extra by header name (pod, delpod, podurl, etc.) */
        function resolveDelPod(doc) {
            if (doc.delPod && String(doc.delPod).trim()) return String(doc.delPod).trim();
            const extra = doc.extra;
            const headerNames = doc.headerNames;
            if (!extra || !Array.isArray(headerNames)) return '';
            const podKeys = ['delpod', 'pod', 'podurl', 'pod_url', 'proofofdelivery', 'deliveryproof', 'podimage', 'pod_image'];
            for (let i = 0; i < headerNames.length; i++) {
                const n = normHeader(headerNames[i]);
                if (podKeys.some(k => n === k || n.includes(k))) {
                    const v = extra['col_' + i];
                    if (v != null && String(v).trim()) return String(v).trim();
                }
            }
            return '';
        }

        /** Normalize a single scan for timeline (consistent field names). */
        function normalizeScan(s) {
            return {
                statusCode: s.statusCode || '',
                statusDateTime: s.statusDateTime || s.statusDate || s.scan_date || '',
                statusDescription: s.statusDescription || s.statusCodeDescription || statusCodeToDisplayName(s.statusCode),
                currentLocation: s.currentLocation || s.location || s.facility || s.hub || s.city || '',
                reasonCodeDescription: s.reasonCodeDescription || s.reasonDescription || '',
            };
        }
        /** Build scans from doc key dates when no scans array, then sort all scans chronologically (oldest first). Returns { scans, derivedFromDates }. */
        function buildScansFromDoc(doc) {
            const deliveredOn = doc.deliveredOn || '';
            const status = (doc.status || '').toUpperCase();
            const isRto = Boolean(doc.isRTO);
            let list = [];
            let derivedFromDates = false;
            if (Array.isArray(doc.scans) && doc.scans.length > 0) {
                list = doc.scans.map(normalizeScan);
            } else {
                derivedFromDates = true;
                const entries = [];
                const push = (code, dateStr, desc, location) => {
                    if (dateStr) entries.push({ statusCode: code, statusDateTime: dateStr, statusDescription: desc, currentLocation: location || '', reasonCodeDescription: '' });
                };
                push('MAN', doc.manifestTime || doc.firstScanTime, 'Manifested', doc.origin);
                push('PKD', doc.bookingDate || doc.pickupTime, 'Picked up', doc.origin);
                push('OFD', doc.ofdTime, 'Out for delivery', doc.destination);
                push(isRto ? 'RTD' : 'DDL', deliveredOn, isRto ? 'RTO Delivered' : 'Delivered', doc.destination);
                list = entries.filter(e => e.statusDateTime);
            }
            const parse = (s) => (s && (new Date(s)).getTime()) || 0;
            list.sort((a, b) => parse(a.statusDateTime) - parse(b.statusDateTime));
            return { scans: list, derivedFromDates };
        }

        /** Map MongoDB shipment doc (Excel upload) to tracking-API-like format for renderShipment */
        function mongoDocToTrackingFormat(doc) {
            const addedOn = doc.bookingDate || doc.uploadedAt || '';
            const edd = doc.edd || '';
            const lastUpdate = doc.deliveredOn || doc.uploadedAt || doc.bookingDate || '';
            const deliveredOn = doc.deliveredOn || '';
            const status = (doc.status || '').toUpperCase();
            const isDelivered = !!deliveredOn || status === 'DDL' || status === 'DELIVERED' || status === 'RTD';
            const isRto = Boolean(doc.isRTO);
            const { scans, derivedFromDates } = buildScansFromDoc(doc);
            const currentStatusCode = isRto && isDelivered ? 'RTD' : isDelivered ? 'DDL' : (status || (isRto ? 'RTO' : ''));
            const currentStatusCodeDescription = statusCodeToDisplayName(currentStatusCode);
            return {
                awbNumber: doc.awb,
                shipperName: doc.customer || 'N/A',
                origin: doc.origin || 'N/A',
                destination: doc.destination || 'N/A',
                currentLocation: doc.destination || (isRto ? 'RTO' : doc.origin) || '',
                currentStatusCode: currentStatusCode,
                currentStatusCodeDescription: currentStatusCodeDescription,
                productType: 'PPD',
                weight: doc.weight || 0,
                pieces: doc.pieces || 1,
                addedOn: addedOn,
                edd: edd,
                currentStatusDateTime: lastUpdate,
                isRto: isRto,
                orderNumber: doc.orderNumber || '',
                currentReasonCode: doc.reasonCode || '',
                currentReasonCodeDescription: doc.reasonDescription || '',
                delPod: resolveDelPod(doc),
                scans,
                trackingDerivedFromDates: derivedFromDates,
            };
        }

        async function loadShipment() {
            const awb = document.getElementById('awbInput').value.trim();
            if (!awb) {
                alert('Please enter an AWB number');
                return;
            }

            document.getElementById('loadingIndicator').classList.remove('hidden');
            
            try {
                let data = null;
                if (typeof API !== 'undefined' && API.getShipmentByAwbFromMongo) {
                    data = await API.getShipmentByAwbFromMongo(awb);
                    if (data) data = mongoDocToTrackingFormat(data);
                }
                if (!data && typeof API !== 'undefined' && API.tracking && API.tracking.getByAwb) {
                    try {
                        data = await API.tracking.getByAwb(awb);
                    } catch (e) {
                        if (e.status !== 404) throw e;
                    }
                }
                // Pull POD image URL from tracking API when missing or relative (so image loads from API)
                if (data && typeof API !== 'undefined' && API.tracking && API.tracking.getByAwb) {
                    const pod = (data.delPod || data.podUrl || '').trim();
                    if (!pod || pod.startsWith('/')) {
                        try {
                            const trackingData = await API.tracking.getByAwb(awb);
                            if (trackingData) {
                                const apiPod = (trackingData.delPod || trackingData.pod_url || trackingData.podUrl || trackingData.proof_of_delivery_url || '').trim();
                                if (apiPod) data.delPod = apiPod;
                            }
                        } catch (_) { /* ignore */ }
                    }
                }
                if (data) {
                    renderShipment(data);
                    history.replaceState(null, '', `?awb=${encodeURIComponent(awb)}`);
                } else {
                    document.getElementById('shipmentContent').innerHTML = `
                        <div class="bg-white rounded-xl premium-border premium-shadow p-12 text-center">
                            <iconify-icon icon="solar:close-circle-linear" width="48" class="text-rose-300 mb-4"></iconify-icon>
                            <p class="text-slate-500">No shipment found for AWB: <span class="font-mono font-semibold">${escapeHtml(awb)}</span></p>
                            <p class="text-slate-400 text-xs mt-2">Not in dashboard data or tracking API</p>
                        </div>
                    `;
                }
            } catch (error) {
                console.error('[Shipment] Error:', error);
                document.getElementById('shipmentContent').innerHTML = `
                    <div class="bg-white rounded-xl premium-border premium-shadow p-12 text-center">
                        <iconify-icon icon="solar:danger-triangle-linear" width="48" class="text-rose-300 mb-4"></iconify-icon>
                        <p class="text-rose-600 font-semibold">Error loading shipment</p>
                        <p class="text-slate-500 text-sm mt-2">${escapeHtml(error.message)}</p>
                    </div>
                `;
            } finally {
                document.getElementById('loadingIndicator').classList.add('hidden');
            }
        }

        /**
         * Parse date strings from API format
         */
        function parseApiDate(dateStr) {
            if (!dateStr) return null;
            try {
                if (/^\d{4}-\d{2}-\d{2}$/.test(dateStr)) {
                    const [year, month, day] = dateStr.split('-').map(Number);
                    const date = new Date(year, month - 1, day);
                    date.setHours(0, 0, 0, 0);
                    return date;
                }
                const months = { 'Jan': 0, 'Feb': 1, 'Mar': 2, 'Apr': 3, 'May': 4, 'Jun': 5,
                    'Jul': 6, 'Aug': 7, 'Sep': 8, 'Oct': 9, 'Nov': 10, 'Dec': 11 };
                const match = dateStr.match(/(\d{1,2})\s+(\w{3})\s+(\d{4})/);
                if (match) {
                    const [, day, monthStr, year] = match;
                    const month = months[monthStr];
                    if (month !== undefined) {
                        const date = new Date(parseInt(year), month, parseInt(day));
                        date.setHours(0, 0, 0, 0);
                        return date;
                    }
                }
                const parsed = new Date(dateStr);
                if (!isNaN(parsed.getTime())) {
                    parsed.setHours(0, 0, 0, 0);
                    return parsed;
                }
                return null;
            } catch (e) { return null; }
        }

        /**
         * Calculate lifecycle metrics for the shipment
         */
        function calculateLifecycle(data, statusCode) {
            const LIFECYCLE_LIMIT_DAYS = 15;
            const TERMINAL_STATUSES = ['DDL', 'RTD', 'RTO', 'CAN', 'LOST'];
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const createdAt = parseApiDate(data.addedOn);
            const eddDate = parseApiDate(data.edd);
            
            let deliveredAt = null;
            if ((statusCode === 'DDL' || statusCode === 'RTD') && data.scans && data.scans.length > 0) {
                const deliveryScan = data.scans.find(s => s.statusCode === 'DDL' || s.statusCode === 'RTD');
                if (deliveryScan) deliveredAt = parseApiDate(deliveryScan.statusDateTime);
            }
            
            let shipmentAgeDays = 0;
            if (createdAt) shipmentAgeDays = Math.floor((today - createdAt) / (1000 * 60 * 60 * 24));
            
            const isTerminal = TERMINAL_STATUSES.includes(statusCode);
            const lifecycleBreach = shipmentAgeDays > LIFECYCLE_LIMIT_DAYS && !isTerminal;
            
            let delayedDays = null;
            if (eddDate) {
                if (deliveredAt) {
                    delayedDays = Math.floor((eddDate - deliveredAt) / (1000 * 60 * 60 * 24));
                } else if (!isTerminal) {
                    delayedDays = Math.floor((eddDate - today) / (1000 * 60 * 60 * 24));
                }
            }
            
            const isDelayed = delayedDays !== null && delayedDays < 0;
            
            let slaStatus = 'PENDING';
            if (statusCode === 'DDL' || statusCode === 'RTD') {
                slaStatus = isDelayed ? 'DELAYED' : 'ONTIME';
            } else if (lifecycleBreach) {
                slaStatus = 'BREACH';
            } else if (isDelayed) {
                slaStatus = 'DELAYED';
            } else if (!isTerminal) {
                slaStatus = 'PENDING';
            } else {
                slaStatus = 'FAILED';
            }
            
            return { shipmentAgeDays, delayedDays, lifecycleBreach, isDelayed, slaStatus, deliveredAt };
        }

        /**
         * Render shipment details from API response
         */
        /** Resolve POD URL: relative paths (e.g. /delivery_pods/...) must be requested from the API origin so the backend can serve them */
        function resolvePodUrl(url) {
            const u = (url || '').trim();
            if (!u) return '';
            if (u.startsWith('http://') || u.startsWith('https://')) return u;
            if (u.startsWith('/')) {
                const base = (typeof API !== 'undefined' && API.getConfig && API.getConfig().baseUrl) ? API.getConfig().baseUrl : window.location.origin;
                return (base || '').replace(/\/$/, '') + u;
            }
            return u;
        }
        /** URL to use for <img> so POD loads in-page: same-origin use as-is, external use backend proxy to avoid CORS */
        function podImageSrc(absolutePodUrl) {
            if (!absolutePodUrl) return '';
            const origin = window.location.origin;
            try {
                const u = new URL(absolutePodUrl, origin);
                if (u.origin === origin) return absolutePodUrl;
            } catch (_) { return absolutePodUrl; }
            const base = (typeof API !== 'undefined' && API.getConfig && API.getConfig().baseUrl) ? API.getConfig().baseUrl : origin;
            return (base.replace(/\/$/, '') + '/api/v1/dashboard/pod?url=' + encodeURIComponent(absolutePodUrl));
        }

        function renderShipment(data) {
            const statusCode = data.currentStatusCode || '';
            const lifecycle = calculateLifecycle(data, statusCode);
            const rawPod = (data.delPod || data.podUrl || data.pod_url || data.proofOfDelivery || '').trim();
            const delPod = resolvePodUrl(rawPod);
            
            const shipment = {
                awb: String(data.awbNumber || ''),
                orderNumber: data.orderNumber || '',
                status: data.currentStatusCodeDescription || data.currentStatusCode || 'Unknown',
                statusCode: statusCode,
                customer: data.shipperName || 'N/A',
                origin: data.origin || 'N/A',
                destination: data.destination || 'N/A',
                currentLocation: data.currentLocation || data.destination || '',
                type: data.productType || 'PPD',
                weight: data.weight || 0,
                pieces: data.pieces || 1,
                addedOn: data.addedOn || 'N/A',
                edd: data.edd || 'N/A',
                lastUpdate: data.currentStatusDateTime || 'N/A',
                isRto: data.isRto || false,
                rtoStatus: data.rto_status || 0,
                delPod: delPod,
                reasonCode: data.currentReasonCode || '',
                reasonDescription: data.currentReasonCodeDescription || '',
                scans: data.scans || [],
                trackingDerivedFromDates: !!data.trackingDerivedFromDates,
                ...lifecycle,
            };
            
            // Find delivery date from scans if delivered
            let deliveryDate = '';
            if (shipment.statusCode === 'DDL' && shipment.scans.length > 0) {
                const deliveryScan = shipment.scans.find(s => s.statusCode === 'DDL');
                if (deliveryScan) deliveryDate = deliveryScan.statusDateTime;
            }

            const content = document.getElementById('shipmentContent');
            
            content.innerHTML = `
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    
                    <!-- Main Info -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-white rounded-xl premium-border premium-shadow p-6">
                            <div class="flex justify-between items-start mb-6">
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase">AWB Number</p>
                                    <h2 class="text-xl font-bold text-slate-900 font-mono">${escapeHtml(shipment.awb)}</h2>
                                    ${shipment.orderNumber ? `<p class="text-xs text-slate-500 mt-1">Order: #${escapeHtml(shipment.orderNumber)}</p>` : ''}
                                </div>
                                <div class="flex items-center gap-2">
                                    <span class="px-3 py-1.5 rounded-full text-xs font-semibold ${getStatusClass(shipment.statusCode)}">${escapeHtml(shipment.status || statusCodeToDisplayName(shipment.statusCode))}</span>
                                </div>
                            </div>
                            
                            ${shipment.reasonDescription ? `
                            <div class="mb-6 p-4 bg-amber-50 border border-amber-200 rounded-lg">
                                <p class="text-[10px] font-semibold text-amber-600 uppercase mb-1">Current Status Reason</p>
                                <p class="text-sm text-amber-800">${escapeHtml(shipment.reasonDescription)}</p>
                                ${shipment.reasonCode ? `<p class="text-[10px] text-amber-600 mt-1">Code: ${escapeHtml(shipment.reasonCode)}</p>` : ''}
                            </div>
                            ` : ''}
                            
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-6">
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Shipper</p>
                                    <p class="text-sm font-medium text-slate-900">${escapeHtml(shipment.customer)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Current Location</p>
                                    <p class="text-sm font-medium text-slate-900">${escapeHtml(shipment.currentLocation) || 'N/A'}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Payment Type</p>
                                    <span class="px-2 py-0.5 rounded text-[10px] font-semibold ${shipment.type === 'COD' ? 'bg-amber-100 text-amber-700' : 'bg-blue-100 text-blue-700'}">${escapeHtml(shipment.type)}</span>
                                </div>
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Origin</p>
                                    <p class="text-sm font-medium text-slate-900">${escapeHtml(shipment.origin)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Destination</p>
                                    <p class="text-sm font-medium text-slate-900">${escapeHtml(shipment.destination)}</p>
                                </div>
                                <div>
                                    <p class="text-[10px] font-semibold text-slate-400 uppercase mb-1">Weight / Pieces</p>
                                    <p class="text-sm font-medium text-slate-900">${shipment.weight} kg / ${shipment.pieces} pc</p>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Tracking History (detailed shipment timeline, oldest first) -->
                        <div class="bg-white rounded-xl premium-border premium-shadow p-6">
                            <h3 class="text-base font-bold text-slate-900 mb-1">Tracking History</h3>
                            <p class="text-xs text-slate-500 mb-1">${shipment.scans.length} event${shipment.scans.length !== 1 ? 's' : ''}${shipment.trackingDerivedFromDates ? ' (from key dates)' : ''}</p>
                            ${shipment.trackingDerivedFromDates ? '<p class="text-[10px] text-slate-400 mb-2">Built from manifest, pickup, OFD and delivery dates in your data.</p>' : ''}
                            ${shipment.scans.length > 8 ? '<p class="text-[10px] text-slate-400 mb-2">Scroll to see all events</p>' : ''}
                            <div id="timeline" class="space-y-4 max-h-[32rem] overflow-y-auto pr-1">
                                ${renderTimeline(shipment.scans)}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar -->
                    <div class="space-y-6">
                        <!-- SLA Status Card (match reference: BREACH badge, Delay box, Shipment Age, Lifecycle Breach) -->
                        <div class="bg-white rounded-xl premium-border premium-shadow p-6 ${shipment.lifecycleBreach ? 'ring-2 ring-orange-400' : shipment.isDelayed ? 'ring-2 ring-rose-400' : ''}">
                            <h3 class="text-sm font-bold text-slate-900 mb-4 flex items-center gap-2">
                                SLA Status
                                ${shipment.slaStatus === 'BREACH' || shipment.lifecycleBreach ? '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-orange-100 text-orange-700">BREACH</span>' : ''}
                            </h3>
                            <div class="space-y-4">
                                <!-- Delay Status (large box, red when past EDD) -->
                                <div class="p-4 rounded-lg ${shipment.delayedDays !== null && shipment.delayedDays < 0 ? 'bg-rose-100 border border-rose-300' : shipment.delayedDays !== null && shipment.delayedDays >= 0 ? 'bg-emerald-50 border border-emerald-200' : 'bg-slate-50 border border-slate-200'}">
                                    <p class="text-[10px] font-semibold text-slate-500 uppercase mb-1">Delay Status</p>
                                    ${shipment.delayedDays !== null ? `
                                        <p class="text-2xl font-bold ${shipment.delayedDays < 0 ? 'text-rose-600' : 'text-emerald-600'}">
                                            ${shipment.delayedDays < 0 ? shipment.delayedDays : '+' + shipment.delayedDays} days
                                        </p>
                                        <p class="text-xs font-medium ${shipment.delayedDays < 0 ? 'text-rose-600' : 'text-emerald-600'}">
                                            ${shipment.delayedDays < 0 ? 'Past EDD' : shipment.delayedDays === 0 ? 'On schedule' : 'Ahead of schedule'}
                                        </p>
                                    ` : '<p class="text-lg font-semibold text-slate-400">—</p><p class="text-xs text-slate-400">No EDD available</p>'}
                                </div>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-slate-500">Shipment Age</span>
                                    <span class="font-semibold text-slate-900">${shipment.shipmentAgeDays != null ? shipment.shipmentAgeDays + ' days' : '—'}</span>
                                </div>
                                <div class="flex items-center justify-between text-xs">
                                    <span class="text-slate-500">SLA Status</span>
                                    <span class="px-2 py-0.5 rounded-full text-[10px] font-semibold ${
                                        shipment.slaStatus === 'ONTIME' ? 'bg-emerald-100 text-emerald-700' :
                                        shipment.slaStatus === 'DELAYED' ? 'bg-rose-100 text-rose-700' :
                                        shipment.slaStatus === 'BREACH' ? 'bg-orange-100 text-orange-700' :
                                        shipment.slaStatus === 'FAILED' ? 'bg-rose-100 text-rose-700' :
                                        'bg-slate-100 text-slate-600'
                                    }">${shipment.slaStatus}</span>
                                </div>
                                ${shipment.lifecycleBreach ? `
                                <div class="p-3 bg-orange-50 border border-orange-200 rounded-lg">
                                    <p class="text-xs font-semibold text-orange-800 flex items-center gap-1">
                                        <iconify-icon icon="solar:danger-triangle-bold" width="12"></iconify-icon>
                                        Lifecycle Breach
                                    </p>
                                    <p class="text-[10px] text-orange-600 mt-1">Shipment exceeded 15 days without terminal status</p>
                                </div>
                                ` : ''}
                            </div>
                        </div>

                        <!-- Key Dates -->
                        <div class="bg-white rounded-xl premium-border premium-shadow p-6">
                            <h3 class="text-sm font-bold text-slate-900 mb-4">Key Dates</h3>
                            <div class="space-y-3 text-xs">
                                <div class="flex justify-between">
                                    <span class="text-slate-500">Added On</span>
                                    <span class="font-semibold text-slate-900">${escapeHtml(shipment.addedOn)}</span>
                                </div>
                                <div class="flex justify-between items-center">
                                    <span class="text-slate-500">EDD</span>
                                    <span class="font-semibold ${shipment.isDelayed ? 'text-rose-600' : 'text-slate-900'}">${escapeHtml(shipment.edd)}</span>
                                </div>
                                <div class="flex justify-between">
                                    <span class="text-slate-500">Last Update</span>
                                    <span class="font-semibold text-slate-900">${escapeHtml(shipment.lastUpdate)}</span>
                                </div>
                                ${deliveryDate ? `
                                <div class="flex justify-between">
                                    <span class="text-slate-500">Delivered On</span>
                                    <span class="font-semibold text-emerald-600">${escapeHtml(deliveryDate)}</span>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        
                        <!-- Proof of Delivery (always show section) -->
                        <div class="bg-white rounded-xl premium-border premium-shadow p-6">
                            <h3 class="text-sm font-bold text-slate-900 mb-4">Proof of Delivery</h3>
                            ${shipment.delPod ? `
                            <div class="block">
                                <img src="${escapeHtml(podImageSrc(shipment.delPod))}" alt="Proof of delivery" class="w-full rounded-lg border border-slate-200 hover:border-blue-400 transition-colors object-contain max-h-80 bg-slate-50" loading="lazy" referrerpolicy="no-referrer" onerror="this.style.display='none'; var n=this.nextElementSibling; if(n) n.style.display='block';">
                                <p class="text-xs text-slate-500 p-4 text-center bg-slate-50 rounded-lg border border-slate-200" style="display:none;">Image could not be loaded. <a href="${escapeHtml(shipment.delPod)}" target="_blank" rel="noopener" class="text-blue-600 font-medium">Open link</a></p>
                            </div>
                            <a href="${escapeHtml(shipment.delPod)}" target="_blank" rel="noopener" class="mt-3 flex items-center justify-center gap-2 text-xs text-blue-600 hover:text-blue-800 font-medium">
                                <iconify-icon icon="solar:gallery-wide-linear" width="14"></iconify-icon>
                                View Full Image
                            </a>
                            ` : `
                            <p class="text-sm text-slate-500 py-4 text-center">No POD image available for this shipment.</p>
                            <p class="text-[10px] text-slate-400 text-center">If your Excel has a POD column (e.g. POD, delPod, Proof of Delivery), re-upload and it will appear here.</p>
                            `}
                        </div>
                        
                        <button onclick="loadShipment()" class="w-full px-4 py-3 text-sm font-semibold text-white bg-slate-900 rounded-lg hover:bg-slate-800 flex items-center justify-center gap-2">
                            <iconify-icon icon="solar:refresh-linear" width="16"></iconify-icon>
                            Refresh Tracking
                        </button>
                    </div>
                </div>
            `;
        }

        /** Format timeline date for display: "03 Jan 2026, 16:19" (preserves time; does not use parseApiDate which zeros time) */
        function formatTimelineDate(dateStr) {
            if (!dateStr || typeof dateStr !== 'string') return '';
            const d = new Date(dateStr.trim());
            if (isNaN(d.getTime())) return dateStr.trim();
            const day = d.getDate();
            const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
            const month = months[d.getMonth()];
            const year = d.getFullYear();
            const h = d.getHours();
            const m = d.getMinutes();
            const time = (h < 10 ? '0' : '') + h + ':' + (m < 10 ? '0' : '') + m;
            return day + ' ' + month + ' ' + year + ', ' + time;
        }

        /** Get first non-empty string from scan using common API field names */
        function scanVal(scan, keys) {
            for (const k of keys) {
                const v = scan[k];
                if (v != null && String(v).trim() !== '') return String(v).trim();
            }
            return '';
        }

        /**
         * Render timeline from scans array (newest first). Uses all common field names so API variations show fully.
         */
        function renderTimeline(scans) {
            if (!scans || scans.length === 0) {
                return '<p class="text-sm text-slate-400">No tracking history available</p>';
            }
            const ordered = [...scans].sort((a, b) => (new Date(a.statusDateTime || 0)).getTime() - (new Date(b.statusDateTime || 0)).getTime());

            return ordered.map((scan, i) => {
                const desc = scanVal(scan, ['statusDescription', 'statusCodeDescription', 'status_code_description', 'status_description', 'description']) || statusCodeToDisplayName(scanVal(scan, ['statusCode', 'status_code'])) || 'Update';
                const statusCode = scanVal(scan, ['statusCode', 'status_code']);
                const statusIcon = getStatusIcon(statusCode);
                const statusColor = getTimelineColor(statusCode);
                const location = scanVal(scan, ['currentLocation', 'current_location', 'location', 'facility', 'hub', 'city']);
                const dateDisplay = formatTimelineDate(scanVal(scan, ['statusDateTime', 'status_date_time', 'statusDate', 'scan_date', 'createdAt', 'created_at']));
                const reason = scanVal(scan, ['reasonCodeDescription', 'reason_description', 'reason_code_description', 'reasonDescription', 'remarks', 'comment', 'instruction', 'notes']);
                const reasonCode = scanVal(scan, ['reasonCode', 'reason_code']);
                const showReason = reason || (reasonCode ? 'Code: ' + reasonCode : '');
                const extraLine = scanVal(scan, ['instruction', 'notes', 'remarks', 'comment']);
                const showExtra = extraLine && extraLine !== reason ? extraLine : '';
                return `
                    <div class="flex gap-4">
                        <div class="flex flex-col items-center">
                            <div class="w-8 h-8 rounded-full flex items-center justify-center ${statusColor}">
                                <iconify-icon icon="${statusIcon}" width="14"></iconify-icon>
                            </div>
                            ${i < (ordered.length - 1) ? '<div class="w-0.5 flex-1 bg-slate-200 min-h-[20px]"></div>' : ''}
                        </div>
                        <div class="pb-5 flex-1 min-w-0">
                            <div class="flex items-center justify-between gap-2">
                                <p class="text-sm font-semibold text-slate-900">${escapeHtml(desc)}</p>
                                <span class="text-[10px] font-medium text-slate-500 shrink-0 px-2 py-0.5 rounded bg-slate-100">${escapeHtml(statusCode)}</span>
                            </div>
                            ${location ? `<p class="text-xs text-slate-600 mt-1">${escapeHtml(location)}</p>` : ''}
                            ${dateDisplay ? `<p class="text-xs text-slate-500 mt-0.5">${escapeHtml(dateDisplay)}</p>` : ''}
                            ${showReason ? `<p class="text-xs text-amber-700 mt-1 font-medium">${escapeHtml(showReason)}</p>` : ''}
                            ${showExtra ? `<p class="text-[10px] text-slate-500 mt-0.5">${escapeHtml(showExtra)}</p>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function getStatusIcon(code) {
            const c = (code || '').toUpperCase();
            const icons = {
                'DDL': 'solar:check-circle-bold',
                'RTD': 'solar:delivery-linear',
                'RTO': 'solar:return-up-back-linear',
                'RTL': 'solar:lock-linear',
                'UDD': 'solar:close-circle-linear',
                'OFD': 'solar:delivery-linear',
                'DDS': 'solar:calendar-linear',
                'PKD': 'solar:box-linear',
                'MAN': 'solar:clipboard-list-linear',
                'IND': 'solar:inbox-in-linear',
                'BGD': 'solar:bag-check-linear',
                'DPD': 'solar:routing-linear',
                'ARD': 'solar:map-arrow-down-linear',
                'RDC': 'solar:buildings-linear',
                'DBG': 'solar:inbox-out-linear',
            };
            return icons[c] || 'solar:point-on-map-linear';
        }

        function getTimelineColor(code) {
            const c = (code || '').toUpperCase();
            if (c === 'DDL') return 'bg-emerald-100 text-emerald-600';
            if (c === 'RTD') return 'bg-blue-100 text-blue-600';
            if (c === 'RTO' || c === 'RTL') return 'bg-red-100 text-red-600';
            if (c === 'UDD') return 'bg-rose-100 text-rose-600';
            if (c === 'OFD' || c === 'DDS') return 'bg-amber-100 text-amber-600';
            return 'bg-blue-100 text-blue-600';
        }

        function getStatusClass(statusCode) {
            const code = (statusCode || '').toUpperCase();
            if (code === 'DDL') return 'bg-emerald-100 text-emerald-700';
            if (code === 'RTD' || code === 'RTO') return 'bg-slate-100 text-slate-700';
            if (['MAN', 'PKD', 'IND', 'BGD', 'DPD', 'ARD', 'RDC', 'DBG'].includes(code)) return 'bg-blue-100 text-blue-700';
            if (code === 'OFD' || code === 'DDS') return 'bg-amber-100 text-amber-700';
            if (code === 'UDD' || code === 'NDR') return 'bg-orange-100 text-orange-700';
            if (code === 'CAN') return 'bg-slate-100 text-slate-700';
            return 'bg-slate-100 text-slate-700';
        }

        // Enter key to track
        document.getElementById('awbInput').addEventListener('keydown', (e) => {
            if (e.key === 'Enter') loadShipment();
        });

        // Add CSS for animations
        const style = document.createElement('style');
        style.textContent = '.animate-spin { animation: spin 1s linear infinite; } @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }';
        document.head.appendChild(style);
    </script>
</body>
</html>
