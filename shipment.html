<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UrbaneBolt • Shipment Detail</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://code.iconify.design/iconify-icon/1.0.7/iconify-icon.min.js"></script>

    <!-- Supabase -->
    <meta name="supabase-url" content="https://eorcmxacpyphsvjwtmbc.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVvcmNteGFjcHlwaHN2and0bWJjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3OTk5OTMsImV4cCI6MjA4NDM3NTk5M30.l-nvIX7nkuRBhLoT-T6QlYtQNpd1JarFCqX8D-HRXt4">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="assets/supabase-runtime.js"></script>
    <script src="assets/nav.js" defer></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        .premium-shadow { box-shadow: 0 2px 10px rgba(0,0,0,0.02), 0 10px 25px rgba(0,0,0,0.03); }
        .premium-border { border: 1px solid #e2e8f0; }
    </style>
</head>
<body class="text-slate-600 antialiased h-screen flex overflow-hidden selection:bg-slate-200 selection:text-slate-900">

    <!-- Sidebar -->
    <aside class="w-72 bg-white border-r border-slate-200 flex flex-col justify-between z-20 hidden md:flex shadow-[4px_0_24px_rgba(0,0,0,0.01)]">
        <div>
            <div class="h-16 flex items-center px-6 border-b border-slate-100">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 bg-slate-900 text-white rounded-lg flex items-center justify-center">
                        <iconify-icon icon="solar:box-minimalistic-linear" width="20" stroke-width="1.5"></iconify-icon>
                    </div>
                    <div class="flex flex-col">
                        <span class="font-bold tracking-tight text-slate-900 text-sm leading-none">URBANEBOLT</span>
                        <span class="text-[10px] font-medium text-slate-400 mt-1 tracking-wider uppercase"></span>
                    </div>
                </div>
            </div>

            <nav class="p-4 space-y-1">
                <div class="px-3 pb-2 pt-2">
                    <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Core Data</p>
                </div>

                <a href="index.html" data-nav-href="index.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent hover:border-slate-200/50 hover:shadow-sm hover:bg-slate-50 hover:text-slate-900 text-slate-500">
                    <iconify-icon icon="solar:widget-2-linear" class="group-hover:text-slate-900 transition-colors" width="18"></iconify-icon>
                    Overview
                </a>

                <a href="manifest.html" data-nav-href="manifest.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent hover:border-slate-200/50 hover:shadow-sm hover:bg-slate-50 hover:text-slate-900 text-slate-500">
                    <iconify-icon icon="solar:clipboard-list-linear" class="group-hover:text-slate-900 transition-colors" width="18"></iconify-icon>
                    Master Manifest
                </a>

                <a href="riders.html" data-nav-href="riders.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent hover:border-slate-200/50 hover:shadow-sm hover:bg-slate-50 hover:text-slate-900 text-slate-500">
                    <iconify-icon icon="solar:user-hand-up-linear" class="group-hover:text-slate-900 transition-colors" width="18"></iconify-icon>
                    Rider Allocation
                </a>

                <div class="px-3 pb-2 pt-6">
                    <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">NDR & Finance</p>
                </div>

                <a href="cod.html" data-nav-href="cod.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent hover:border-slate-200/50 hover:shadow-sm hover:bg-slate-50 hover:text-slate-900 text-slate-500">
                    <iconify-icon icon="solar:bill-list-linear" class="group-hover:text-slate-900 transition-colors" width="18"></iconify-icon>
                    COD Reconciliation
                </a>

                <a href="exceptions.html" data-nav-href="exceptions.html" class="group flex items-center gap-3 px-3 py-2.5 text-sm font-medium rounded-lg transition-all border border-transparent hover:border-slate-200/50 hover:shadow-sm hover:bg-slate-50 hover:text-slate-900 text-slate-500">
                    <iconify-icon icon="solar:danger-triangle-linear" class="group-hover:text-slate-900 transition-colors" width="18"></iconify-icon>
                    RTO & Exceptions
                </a>
            </nav>
        </div>

        <div class="p-4 border-t border-slate-100">
            <div class="flex items-center gap-3 w-full p-2 rounded-lg border border-slate-200 bg-slate-50">
                <img src="https://ui-avatars.com/api/?name=Ops&background=0f172a&color=fff" alt="User" class="w-8 h-8 rounded-full shadow-sm">
                <div class="flex flex-col min-w-0">
                    <span class="text-xs font-semibold text-slate-900 truncate">UrbaneBolt</span>
                    <span class="text-[10px] text-slate-500 truncate">Public dashboard</span>
                </div>
            </div>
        </div>
    </aside>

    <!-- Main -->
    <main class="flex-1 flex flex-col h-full relative overflow-hidden bg-slate-50/50">
        <header class="h-16 bg-white border-b border-slate-200 flex items-center justify-between px-8 sticky top-0 z-30">
            <div class="flex items-center gap-4">
                <h1 class="text-lg font-semibold text-slate-900 tracking-tight">Shipment Detail</h1>
                <div class="h-4 w-px bg-slate-200"></div>
                <div class="flex items-center gap-2 text-xs text-slate-500 bg-slate-100/50 px-2 py-1 rounded-md border border-slate-200">
                    <iconify-icon icon="solar:calendar-linear" width="14"></iconify-icon>
                    <span id="currentDate"></span>
                </div>
            </div>

            <div class="flex items-center gap-2">
                <span class="text-xs font-semibold text-slate-500">Public</span>
            </div>
        </header>

        <div class="flex-1 overflow-y-auto p-8 space-y-6">
            <div class="flex items-center justify-between">
                <a href="index.html" class="inline-flex items-center gap-2 text-xs font-semibold text-blue-600 hover:underline">
                    <iconify-icon icon="solar:alt-arrow-left-linear"></iconify-icon>
                    Back to Dashboard
                </a>
                <span id="awbBadge" class="text-xs font-semibold text-slate-500"></span>
            </div>

            <div id="stateCard" class="bg-white rounded-xl p-6 premium-border premium-shadow">
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-sm font-bold text-slate-900">Loading…</h2>
                        <p class="text-xs text-slate-500 mt-1">Fetching shipment record.</p>
                    </div>
                    <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Live</span>
                </div>
            </div>

            <div id="detailGrid" class="hidden grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2 bg-white rounded-xl p-6 premium-border premium-shadow">
                    <div class="flex items-start justify-between">
                        <div>
                            <h3 class="text-sm font-bold text-slate-900">Shipment Summary</h3>
                            <p class="text-xs text-slate-500 mt-0.5">Key fields from the shipments table</p>
                        </div>
                        <div id="statusPill"></div>
                    </div>

                    <div class="mt-5 grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Customer</p>
                            <p id="customer" class="mt-2 font-semibold text-slate-900">—</p>
                            <p id="order" class="mt-1 text-xs text-slate-500">—</p>
                        </div>
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Route</p>
                            <p id="route" class="mt-2 font-semibold text-slate-900">—</p>
                            <p id="pins" class="mt-1 text-xs text-slate-500">—</p>
                        </div>
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Service</p>
                            <p id="service" class="mt-2 font-semibold text-slate-900">—</p>
                            <p id="product" class="mt-1 text-xs text-slate-500">—</p>
                        </div>
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Value</p>
                            <p id="codValue" class="mt-2 font-semibold text-slate-900">—</p>
                            <p id="declaredValue" class="mt-1 text-xs text-slate-500">—</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-xl p-6 premium-border premium-shadow">
                    <h3 class="text-sm font-bold text-slate-900">Operations</h3>
                    <p class="text-xs text-slate-500 mt-0.5">Delivery attempt and assignment signals</p>

                    <div class="mt-5 space-y-3">
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Rider</p>
                            <p id="rider" class="mt-2 font-semibold text-slate-900">—</p>
                        </div>
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">EDD</p>
                            <p id="edd" class="mt-2 font-semibold text-slate-900">—</p>
                        </div>
                        <div class="p-4 rounded-lg border border-slate-200 bg-slate-50">
                            <p class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Attempts</p>
                            <p id="attempts" class="mt-2 font-semibold text-slate-900">—</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        function escapeHtml(value) {
            return String(value ?? '')
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }

        function formatCurrency(value) {
            return new Intl.NumberFormat('en-IN', { style: 'currency', currency: 'INR', maximumFractionDigits: 0 }).format(value || 0);
        }

        function getStatusCategory(status, code) {
            const c = String(code || '').trim().toUpperCase();
            const s = String(status || '').trim().toLowerCase();
            const deliveredCodes = new Set(['DEL', 'DLV', 'DELIVERED']);
            const inProgressCodes = new Set(['INT', 'OFD', 'OFD1', 'OFD2', 'IT', 'INTRANSIT']);
            const cancelledCodes = new Set(['CNL', 'CAN', 'CX', 'CANC', 'CNCL', 'CANCELED', 'CANCELLED']);
            const exceptionCodes = new Set(['UD', 'RTO', 'NDR', 'FAILED', 'FAIL']);

            if (deliveredCodes.has(c) || s.includes('delivered')) return 'delivered';
            if (cancelledCodes.has(c) || s.includes('cancel')) return 'cancelled';
            if (exceptionCodes.has(c) || s.includes('undeliver') || s.includes('failed') || s.includes('rto') || s.includes('ndr')) return 'exception';
            if (inProgressCodes.has(c) || s.includes('in progress') || s.includes('in-transit') || s.includes('in transit') || s.includes('out for delivery') || s.includes('transit')) return 'in-progress';
            return 'other';
        }

        function statusPillHtml(status, code) {
            const category = getStatusCategory(status, code);
            const theme = {
                delivered: { pill: 'bg-emerald-50 text-emerald-700 border border-emerald-200/60', dot: 'bg-emerald-500' },
                'in-progress': { pill: 'bg-blue-50 text-blue-700 border border-blue-200/60', dot: 'bg-blue-500' },
                cancelled: { pill: 'bg-rose-50 text-rose-700 border border-rose-200/60', dot: 'bg-rose-500' },
                exception: { pill: 'bg-amber-50 text-amber-800 border border-amber-200/60', dot: 'bg-amber-500' },
                other: { pill: 'bg-slate-100 text-slate-700 border border-slate-200', dot: 'bg-slate-400' }
            }[category];

            const safeStatus = escapeHtml(status || 'Unknown');
            const safeCode = escapeHtml((code || '').toString());
            return `
                <span class="inline-flex items-center gap-2 px-2 py-1 rounded-md text-xs font-semibold ${theme.pill}" title="${safeCode}">
                    <span class="w-1.5 h-1.5 rounded-full ${theme.dot}"></span>
                    ${safeStatus}
                </span>
            `;
        }

        const currentDateEl = document.getElementById('currentDate');
        if (currentDateEl) {
            currentDateEl.textContent = new Date().toLocaleDateString('en-IN', { weekday: 'short', year: 'numeric', month: 'short', day: 'numeric' });
        }

        const u = new URL(window.location.href);
        const awb = (u.searchParams.get('awb') || '').trim();
        const awbBadge = document.getElementById('awbBadge');
        if (awbBadge) awbBadge.textContent = awb ? `AWB: ${awb}` : '';

        function setStateCard(title, subtitle, tone) {
            const card = document.getElementById('stateCard');
            if (!card) return;
            const styles = {
                info: 'border-slate-200 bg-white',
                warn: 'border-amber-200 bg-amber-50/40',
                error: 'border-rose-200 bg-rose-50/40',
            }[tone || 'info'];
            card.className = `bg-white rounded-xl p-6 premium-border premium-shadow ${styles}`;
            card.innerHTML = `
                <div class="flex items-start justify-between">
                    <div>
                        <h2 class="text-sm font-bold text-slate-900">${escapeHtml(title)}</h2>
                        <p class="text-xs text-slate-500 mt-1">${escapeHtml(subtitle)}</p>
                    </div>
                    <span class="text-[10px] font-semibold text-slate-400 uppercase tracking-widest">Live</span>
                </div>
            `;
        }

        // Public mode: no auth required.
        (async function loadShipment() {
            if (!awb) {
                setStateCard('Missing AWB', 'Open this page from the dashboard by clicking an AWB, or pass ?awb=XXXX', 'warn');
                return;
            }

            const client = window.__getSupabaseClient?.();
            if (!client) {
                setStateCard('Supabase not configured', 'Missing Supabase URL or anon key.', 'error');
                return;
            }

            setStateCard('Loading…', 'Fetching shipment record.', 'info');

            const { data, error } = await client.from('shipments').select('*').eq('awbNumber', awb).limit(1).maybeSingle();
            if (error) {
                console.error(error);
                setStateCard('Unable to load shipment', error.message || 'Supabase error', 'error');
                return;
            }
            if (!data) {
                setStateCard('Shipment not found', `No record found for AWB ${awb}`, 'warn');
                return;
            }

            // Populate UI
            document.title = `UrbaneBolt • ${awb}`;
            const detailGrid = document.getElementById('detailGrid');
            if (detailGrid) detailGrid.classList.remove('hidden');

            const statusEl = document.getElementById('statusPill');
            if (statusEl) statusEl.innerHTML = statusPillHtml(data.statusDescription, data.statusCode);

            const setText = (id, value) => {
                const el = document.getElementById(id);
                if (el) el.textContent = value;
            };

            setText('customer', data.customerName || '—');
            setText('order', data.order_number ? `Ord: ${data.order_number}` : '—');
            setText('route', `${data.origin || '—'} → ${data.destination || '—'}`);
            setText('pins', `${data.originPincode || '—'} → ${data.destinationPincode || '—'}`);
            setText('service', data.serviceType || '—');
            setText('product', data.product_type || '—');
            setText('codValue', formatCurrency(Number(data.collectable_value) || 0));
            setText('declaredValue', `Declared: ${formatCurrency(Number(data.declared_value) || 0)}`);
            setText('rider', data.riderName || 'Unassigned');
            setText('edd', data.edd || '—');
            setText('attempts', typeof data.attemptCount === 'number' ? String(data.attemptCount) : '—');

            setStateCard('Loaded', 'Shipment record loaded successfully.', 'info');
        })();
    </script>
</body>
</html>

